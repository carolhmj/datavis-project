<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Uma exploração da felicidade</title>

    <link rel="stylesheet" href="css/dc.css">
    <!--<link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purT +FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ==" crossorigin=""/>-->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" 
    integrity="sha256-LcmP8hlMTofQrGU6W2q3tUnDnDZ1QVraxfMkP060ekM=" crossorigin=""/>

    <script src="js/crossfilter.js" charset="utf-8"></script>
    <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="js/dc.js" charset="utf-8"></script>
    <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"
    integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log==" crossorigin=""></script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>

    <link rel="stylesheet" href="css/map.css">
    <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script> 

    <link rel="stylesheet" href="css/style.css">
    <script src="js/script.js" charset="utf-8"></script>
</head>
<body>
    <div id="wrapper">
        <div id="menu">
            <a href="#1">Seção 1</a>
            <a href="#2">Seção 2</a>
        </div>
        <div id="main">
            <section id="header">
                <h1>Uma exploração da felicidade</h1>
                <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Donec sollicitudin laoreet libero vel feugiat. Vivamus ac leo sed mi congue posuere et ut purus. Phasellus vitae lectus in ligula dignissim congue. Sed ut tincidunt mi, ac facilisis nisi. Suspendisse mollis efficitur elit sit amet rutrum. Nulla commodo nibh sem, ac congue elit tempor non. Donec eleifend pretium ex. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Phasellus placerat dictum odio a accumsan. Pellentesque faucibus ipsum at magna vestibulum elementum.</p>
            </section>
            <div id="worldmap"></div>
            <div>
              <input id="year-slider" type="range" min="1" max="3" steps="1" value="1" >
            </div>
            <ul class="range-labels">
              <li class="active selected">Today</li>
              <li>2 days</li>
              <li>3 days</li>
            </ul>
            <div class="country-name"></div>
            <section id="1">
                <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Donec sollicitudin laoreet libero vel feugiat. Vivamus ac leo sed mi congue posuere et ut purus. Phasellus vitae lectus in ligula dignissim congue. Sed ut tincidunt mi, ac facilisis nisi. Suspendisse mollis efficitur elit sit amet rutrum. Nulla commodo nibh sem, ac congue elit tempor non. Donec eleifend pretium ex. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Phasellus placerat dictum odio a accumsan. Pellentesque faucibus ipsum at magna vestibulum elementum.</p>
                <div id="happinessFactors"></div>
            </section>
            
            <section id="2">
                <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Donec sollicitudin laoreet libero vel feugiat. Vivamus ac leo sed mi congue posuere et ut purus. Phasellus vitae lectus in ligula dignissim congue. Sed ut tincidunt mi, ac facilisis nisi. Suspendisse mollis efficitur elit sit amet rutrum. Nulla commodo nibh sem, ac congue elit tempor non. Donec eleifend pretium ex. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Phasellus placerat dictum odio a accumsan. Pellentesque faucibus ipsum at magna vestibulum elementum.</p>
            </section>            
        </div>
        <div id="footer">
            <h4>Projeto final para a disciplina de Visualização de Dados (2017.2)</h4>
            <h5>Universidade Federal do Ceará</h5>
            <p><strong>Professora:</strong> <a href="https://emanueles.github.io" target="_blank">Emanuele Santos</a></p>
            <p><strong>Autores:</strong> <a href="#" target="_blank">Carol Herbster</a>, <a href="https://erickkelvin.github.io" target="_blank">Erick Santos</a> e <a href="#" target="_blank">Mariana Fontenele</a></p>
        </div>
    </div>
    <script>
    // Copyright (c) 2013 Ryan Clark
    // https://gist.github.com/rclark/5779673
    L.TopoJSON = L.GeoJSON.extend({
        addData: function(jsonData) {    
            if (jsonData.type === "Topology") {
                for (key in jsonData.objects) {
                    geojson = topojson.feature(jsonData, jsonData.objects[key]);
                    L.GeoJSON.prototype.addData.call(this, geojson);
                }
            }    
            else {
                L.GeoJSON.prototype.addData.call(this, jsonData);
            }
        }  
    });
    </script>
    <script>

        (function(){

        'use strict'
          
        const map = L.map('worldmap',{maxZoom:10,minZoom:1.25}),
        topoLayer = new L.TopoJSON(),
        $countryName = $('.country-name'),
        colorScale = d3.scale.linear()
                    .range(['#FFFDE7', '#FF8F00'])
                    .domain([2,8]);
        
        map.setView([20,0], 2);

        var happinessByCountry;
        var happinessData = [];
        happinessData[0] = "data/HappinessReport/whr2017_topoJSON.csv";
        happinessData[1] = "data/HappinessReport/whr2016_topoJSON.csv";
        happinessData[2] = "data/HappinessReport/whr2015_topoJSON.csv";

        d3.csv(happinessData[0],createHappinessHashMap);
        $.getJSON('data/countries.topo.json').done(addTopoData);
            
        function createHappinessHashMap(data){
            happinessByCountry = d3.map();
            data.forEach(function(d) {
                happinessByCountry.set(d.Country, (+d["Happiness score"]).toFixed(2))
            });
        }

        //add countries layers data to be shown on map
        function addTopoData(topoData){
            topoLayer.addData(topoData);
            topoLayer.addTo(map);
            topoLayer.eachLayer(handleLayer);
        }

        //set countries style, including color and set mouse event functions
        function handleLayer(layer){
            const countryName = layer.feature.properties.name;
            const happinessScore = happinessByCountry.get(countryName);
            let fillColor;

            if (happinessScore){
                fillColor = colorScale(happinessScore);    
            }
            else {
                fillColor = '#f2f2f2'
            }
            
            layer.setStyle({
              fillColor : fillColor,
              fillOpacity: 1,
              color:'#555',
              weight:1,
              opacity:.5
            });

            layer.on({
              mousemove : enterLayer,
              mouseout: leaveLayer
            });
        }

        //when mouse enter layer (country), show tooltip
        function enterLayer(event){
            const countryName = this.feature.properties.name;
            const happinessScore = happinessByCountry.get(countryName);
            let info;

            if (happinessScore){
                info = `${countryName} <br> ${happinessScore}`;
            }
            else{
                info = `${countryName} <br> sem dados`;
            }
            $countryName.html(info).show();

            const eventX = event.containerPoint.x + 220;
            const eventY = event.containerPoint.y + 200;

            const tooltip = document.querySelector(".country-name");
            tooltip.style.left = eventX + 'px';
            tooltip.style.top = eventY + 'px';

            this.bringToFront();
            this.setStyle({
                weight:2,
                opacity: 1
            });
        }

        //slider change callback
        function onSliderChange(data){
            createHappinessHashMap(data);
            topoLayer.eachLayer(handleLayer);
        }

        //check if slider has changed
        $('#year-slider').on('change',function(){
            d3.csv(happinessData[this.value-1],onSliderChange);            
        });

        //when mouse leave layer (country), hide tooltip
        function leaveLayer(){
            $countryName.hide();

            this.bringToBack();
            this.setStyle({
                weight:1,
                opacity:.5
            });
        }

        }());

    </script>
</body>
</html>